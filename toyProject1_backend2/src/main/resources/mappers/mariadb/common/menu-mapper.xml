<?xml version="1.0" encoding="UTF-8" ?>

<mapper namespace="toy.project.apiserver.mapper.common.MenuMapper">

  <!-- 메뉴 트리 조회 (재귀적으로) -->
  <select id="getList" resultType="toy.project.apiserver.DTO.common.MenuAgentDTO">
    WITH RECURSIVE menu_tree AS (
      SELECT 
        id, 
        upper_id, 
        name, 
        description AS path,
        0 AS depth
      FROM 
        menu_agent
      WHERE 
        upper_id IS NULL
      
      UNION ALL
      
      SELECT 
        m.id, 
        m.upper_id, 
        m.name, 
        m.description AS path,
        mt.depth + 1 AS depth
      FROM 
        menu_agent m
      INNER JOIN 
        menu_tree mt 
        ON m.upper_id = mt.id
    )
    SELECT 
      id, 
      upper_id, 
      name, 
      path,
      depth
    FROM 
      menu_tree
    ORDER BY 
      depth, upper_id, id
  </select>

</mapper>